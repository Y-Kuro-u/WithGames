name: CD - Deploy to Cloud Run

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGION: asia-northeast1
  SERVICE_NAME: withgames-bot
  REPO_NAME: withgames-bot

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      
      - name: Determine image tag
        id: image_tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG=$(git rev-parse --short HEAD)
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ steps.image_tag.outputs.tag }}
            ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ steps.image_tag.outputs.tag }} \
            --platform=managed \
            --region=${{ env.REGION }} \
            --service-account=withgames-bot-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --set-env-vars="ENVIRONMENT=production,GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},REMINDER_MINUTES=30" \
            --set-secrets="DISCORD_TOKEN=discord-bot-token:latest,DISCORD_APPLICATION_ID=discord-app-id:latest,EVENT_WEBHOOK_URL=event-webhook-url:latest" \
            --cpu=1 \
            --memory=512Mi \
            --min-instances=1 \
            --max-instances=2 \
            --cpu-boost \
            --no-allow-unauthenticated \
            --timeout=60s \
            --concurrency=80 \
            --quiet
      
      - name: Get service URL
        id: service_url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="value(status.url)")
          echo "url=$URL" >> $GITHUB_OUTPUT
      
      - name: Verify deployment
        run: |
          echo "Deployment completed successfully!"
          echo "Service URL: ${{ steps.service_url.outputs.url }}"
          echo "Image: ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ steps.image_tag.outputs.tag }}"
          
          # ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆæœ€æ–°20è¡Œï¼‰
          echo "Recent logs:"
          gcloud run logs read ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --limit=20
      
      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ Deployment Summary
          
          ## Service Information
          - **Service**: ${{ env.SERVICE_NAME }}
          - **Region**: ${{ env.REGION }}
          - **Image Tag**: ${{ steps.image_tag.outputs.tag }}
          - **Commit**: ${{ github.sha }}
          
          ## Deployment Details
          - **Service URL**: ${{ steps.service_url.outputs.url }}
          - **Console**: [View in Cloud Console](https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}?project=${{ secrets.GCP_PROJECT_ID }})
          - **Logs**: \`gcloud run logs tail ${{ env.SERVICE_NAME }} --region=${{ env.REGION }}\`
          
          ## Image
          \`\`\`
          ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ steps.image_tag.outputs.tag }}
          \`\`\`
          EOF
      
      - name: Notify deployment status (Success)
        if: success()
        run: |
          echo "âœ… Deployment succeeded for ${{ env.SERVICE_NAME }}"
          # ã“ã“ã«Slack/Discordé€šçŸ¥ã‚’è¿½åŠ ã§ãã¾ã™
      
      - name: Notify deployment status (Failure)
        if: failure()
        run: |
          echo "âŒ Deployment failed for ${{ env.SERVICE_NAME }}"
          # ã“ã“ã«Slack/Discordé€šçŸ¥ã‚’è¿½åŠ ã§ãã¾ã™

  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'rollback'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: List revisions
        run: |
          echo "Available revisions:"
          gcloud run revisions list \
            --service=${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="table(name,status,trafficPercent)"
      
      - name: Rollback to previous revision
        run: |
          # æœ€æ–°ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã®1ã¤å‰ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          PREVIOUS_REVISION=$(gcloud run revisions list \
            --service=${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="value(name)" \
            --limit=2 | tail -n 1)
          
          echo "Rolling back to: $PREVIOUS_REVISION"
          
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --to-revisions=$PREVIOUS_REVISION=100 \
            --region=${{ env.REGION }}
          
          echo "âœ… Rollback completed to $PREVIOUS_REVISION"
